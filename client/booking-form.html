<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto-mec - Booking Form</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>

  <!-- Shared Header -->
  <header id="siteHeader"></header>

  <main class="container">
    <h1>Book a Service</h1>

    <form id="bookingForm" autocomplete="off">

      <!-- GPS Info Box -->
      <div class="info-box">
        <p><strong>â„¹ï¸ Why GPS is required:</strong><br />
        We use your location to send the nearest available mobile mechanic.<br />
        <span class="warning-text">Bookings without GPS may be declined.</span></p>
      </div>

      <!-- Location Fields -->
      <label>Your Location</label>
      <button type="button" class="btn-secondary" id="gpsBtn">Use My GPS</button>
      <input
        type="text"
        id="address"
        name="address"
        placeholder="Street & postcode will appear here"
        required
        disabled
      />
      <input
        type="text"
        id="extraDetail"
        name="extraDetail"
        placeholder="Add house number, flat or landmark (optional)"
        disabled
      />

      <!-- Service Details -->
      <label for="serviceType">ğŸ”§ Service Type</label>
      <select id="serviceType" name="serviceType" required disabled>
        <option value="" disabled selected>Select a service</option>
        <option value="Oil Change">Oil Change</option>
        <option value="Brake Service">Brake Service</option>
        <option value="Engine Check">Engine Check</option>
        <option value="Tyre Replacement">Tyre Replacement</option>
      </select>

      <label for="serviceDate">ğŸ—“ Date</label>
      <input type="date" id="serviceDate" name="serviceDate" required disabled />

      <label for="serviceTime">â° Time</label>
      <input type="time" id="serviceTime" name="serviceTime" required disabled />

      <label for="description">ğŸ“ Notes</label>
      <textarea id="description" name="description" rows="4" placeholder="Extra info for the mechanic..." disabled></textarea>

      <button type="submit" class="btn btn-primary" disabled>Submit Booking</button>
    </form>
  </main>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal hidden">
    <div class="modal-content">
      <div id="confirmationText"></div>
      <button id="closeModal" class="btn btn-primary">Close</button>
    </div>
  </div>

  <script>
    // Load shared header
    fetch('../shared/header.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('siteHeader').innerHTML = data;
        const toggle = document.getElementById('navToggle');
        const menu = document.getElementById('navMenu');
        if (toggle && menu) {
          toggle.addEventListener('click', () => {
            menu.classList.toggle('show');
          });
        }
      });

    // Elements
    const gpsBtn = document.getElementById('gpsBtn');
    const addressInput = document.getElementById('address');
    const extraDetailInput = document.getElementById('extraDetail');
    const bookingForm = document.getElementById('bookingForm');
    const formFields = bookingForm.querySelectorAll('select, input:not(#address):not(#extraDetail), textarea, button[type="submit"]');

    // Disable form fields initially except GPS button
    formFields.forEach(el => el.disabled = true);
    addressInput.disabled = true;
    extraDetailInput.disabled = true;

    gpsBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation not supported by your browser.');
        return;
      }

      gpsBtn.textContent = 'Locating...';
      gpsBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`)
            .then(res => res.json())
            .then(data => {
              const display = data.address?.road
                ? `${data.address.road}, ${data.address.postcode || ''}`
                : data.display_name || '';
              addressInput.value = display;
              addressInput.disabled = false;
              extraDetailInput.disabled = false;
              gpsBtn.textContent = 'Use My GPS';
              gpsBtn.disabled = false;

              // Enable all other form fields
              formFields.forEach(el => el.disabled = false);
            })
            .catch(() => {
              alert('Unable to retrieve your address.');
              gpsBtn.textContent = 'Use My GPS';
              gpsBtn.disabled = false;
            });
        },
        () => {
          alert('GPS failed or permission denied. Please enable location to continue.');
          gpsBtn.textContent = 'Use My GPS';
          gpsBtn.disabled = false;
        }
      );
    });

    // Confirmation modal elements
    const modal = document.getElementById('confirmationModal');
    const confirmationText = document.getElementById('confirmationText');
    const closeModal = document.getElementById('closeModal');

    bookingForm.addEventListener('submit', (e) => {
      e.preventDefault();

      if (addressInput.disabled || !addressInput.value.trim()) {
        alert('âŒ Location is required. Please use the GPS button first.');
        return;
      }

      if (!bookingForm.checkValidity()) {
        bookingForm.reportValidity();
        return;
      }

      const formData = new FormData(bookingForm);
      const data = Object.fromEntries(formData.entries());

      const reference = 'AUC' + Math.floor(Math.random() * 900 + 100);
      const fullLocation = `${data.address}${data.extraDetail ? ' - ' + data.extraDetail : ''}`;

      confirmationText.innerHTML = `
        <h2>âœ… Booking Confirmed!</h2>
        <p>ğŸ§¾ <strong>Booking Ref:</strong> #${reference}</p>
        <p>ğŸ”§ <strong>Service:</strong> ${data.serviceType}</p>
        <p>ğŸ—“ <strong>Date:</strong> ${data.serviceDate}</p>
        <p>â° <strong>Time:</strong> ${data.serviceTime}</p>
        <p>ğŸ“ <strong>Location:</strong> ${fullLocation}</p>
        <br>
        <p>â˜ï¸ A member of our team will contact you shortly.</p>
        <p>ğŸ“¸ Please take a screenshot or save this message.</p>
      `;
      modal.classList.remove('hidden');
      bookingForm.reset();

      // Disable fields again after submission
      formFields.forEach(el => el.disabled = true);
      addressInput.disabled = true;
      extraDetailInput.disabled = true;
    });

    closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
  </script>
</body>
</html>